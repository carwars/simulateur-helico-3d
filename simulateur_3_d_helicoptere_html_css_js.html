<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur 3D – Hélicoptère (WebGL)</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121821;--muted:#7d8ca1;--accent:#76e1ff;--good:#4ade80;--warn:#f59e0b;--bad:#ef4444;--grid:12px
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#e6edf6;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .layout{display:grid;grid-template-columns:1fr 360px;grid-template-rows:auto 1fr;gap:var(--grid);height:100%;padding:var(--grid)}
    header{grid-column:1/3;display:flex;justify-content:space-between;align-items:center;background:var(--panel);padding:10px 14px;border-radius:12px;border:1px solid #1c2531}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .status{font-size:12px;color:var(--muted)}

    .main{position:relative;background:#06090e;border:1px solid #1c2531;border-radius:12px;overflow:hidden}
    canvas{display:block;width:100%;height:100%}

    .side{display:grid;grid-template-rows: auto 1fr; gap:var(--grid)}
    .panel{background:var(--panel);border:1px solid #1c2531;border-radius:12px;overflow:hidden}
    .panel h2{font-size:13px;margin:0;padding:8px 10px;border-bottom:1px solid #1c2531;color:#c7d2fe;letter-spacing:.2px}
    .panel .content{padding:10px}

    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .kpi div{background:#0f1620;border:1px solid #1c2531;border-radius:10px;padding:8px 10px}
    .kpi .label{font-size:11px;color:var(--muted)}
    .kpi .value{font-size:18px;font-weight:800}

    .legend {display:grid;grid-template-columns:1fr 1fr; gap:10px; font-size:12px; color:var(--muted)}
    .legend kbd{background:#0b1220;border:1px solid #1b2a44;border-bottom-width:2px;border-radius:6px;padding:2px 6px;color:#e6edf6}

    .toast{position:absolute;bottom:14px;left:14px;background:#0e1724;border:1px solid #1b2a44;padding:10px 12px;border-radius:10px;color:#c7d2fe;box-shadow:0 6px 20px rgba(0,0,0,.4);font-size:13px}

    .attitude{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .gauge{background:#0f1620;border:1px solid #1c2531;border-radius:10px;position:relative;display:flex;align-items:center;justify-content:center;min-height:140px}
    .gauge .readout{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:12px;color:var(--muted)}

    @media (max-width: 1020px){
      .layout{grid-template-columns:1fr;grid-template-rows:auto 52vh auto}
      .side{grid-template-rows:auto auto}
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <h1>Simulateur 3D – Hélicoptère • HTML/CSS/JS (Three.js)</h1>
      <div class="status" id="hdr">Mission : décoller de A, atterrir sur B (Vh < 1 m/s & Alt < 1.5 m)</div>
    </header>

    <section class="main">
      <canvas id="viewFPV" title="Vue subjective 3D"></canvas>
      <div class="toast" id="toast">Espace = +Poussée • Shift = −Poussée • ←/→ Roulis • ↑/↓ Tangage • A/D Lacet • R = Reset • P = Pause</div>
    </section>

    <aside class="side">
      <div class="panel">
        <h2>Vue extérieure & Attitude</h2>
        <div style="position:relative;height:220px">
          <canvas id="viewEXT" style="position:absolute;inset:0"></canvas>
        </div>
        <div class="content">
          <div class="attitude">
            <div class="gauge"><canvas id="horizon" width="240" height="140"></canvas><div class="readout" id="rollTxt">Roulis 0°</div></div>
            <div class="gauge"><canvas id="compass" width="240" height="140"></canvas><div class="readout" id="pitchTxt">Tangage 0°</div></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Paramètres de vol & Aide</h2>
        <div class="content">
          <div class="kpi">
            <div><div class="label">Altitude (m)</div><div class="value" id="alt">0.0</div></div>
            <div><div class="label">Vitesse (m/s)</div><div class="value" id="spd">0.0</div></div>
            <div><div class="label">Cap (°)</div><div class="value" id="hdg">0</div></div>
            <div><div class="label">Poussée</div><div class="value" id="thr">0%</div></div>
            <div><div class="label">Position XY (m)</div><div class="value" id="pos">0, 0</div></div>
            <div><div class="label">État</div><div class="value" id="state">Au sol</div></div>
          </div>
          <div style="margin-top:10px" class="legend">
            <div>
              <p><kbd>Espace</kbd> / <kbd>Shift</kbd> : Poussée ±</p>
              <p><kbd>↑</kbd><kbd>↓</kbd> : Tangage (avant/arrière)</p>
              <p><kbd>←</kbd><kbd>→</kbd> : Roulis (gauche/droite)</p>
            </div>
            <div>
              <p><kbd>A</kbd>/<kbd>D</kbd> : Lacet (cap)</p>
              <p><kbd>R</kbd> : Réinitialiser depuis A</p>
              <p><kbd>P</kbd> : Pause/Reprise</p>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script>
  // ====== Mise en place scènes/rendu ======
  const canvasFPV = document.getElementById('viewFPV');
  const canvasEXT = document.getElementById('viewEXT');
  const renFPV = new THREE.WebGLRenderer({canvas:canvasFPV, antialias:true});
  const renEXT = new THREE.WebGLRenderer({canvas:canvasEXT, antialias:true});
  renFPV.setPixelRatio(devicePixelRatio); renEXT.setPixelRatio(devicePixelRatio);

  const scene = new THREE.Scene(); scene.background = new THREE.Color(0x061018);
  const camFPV = new THREE.PerspectiveCamera(70, 1, 0.1, 3000);
  const camEXT = new THREE.PerspectiveCamera(60, 1, 0.1, 3000);

  scene.add(new THREE.HemisphereLight(0xbfd7ff, 0x0b1118, 1.1));
  const sun = new THREE.DirectionalLight(0xffffff,.9); sun.position.set(200,300,160); scene.add(sun);

  // Sol & repères A/B
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(4000,4000), new THREE.MeshStandardMaterial({color:0x0c1a22, roughness:1}));
  ground.rotation.x = -Math.PI/2; scene.add(ground);
  const grid = new THREE.GridHelper(4000, 200, 0x1b2a44, 0x122031); grid.material.opacity=.45; grid.material.transparent=true; scene.add(grid);

  function labelSprite(text,color){
    const c=document.createElement('canvas'); c.width=256; c.height=128; const x=c.getContext('2d');
    x.font='bold 64px system-ui'; x.textAlign='center'; x.textBaseline='middle'; x.fillStyle='rgba(0,0,0,0)'; x.fillRect(0,0,256,128);
    x.fillStyle=color; x.fillText(text,128,64);
    const t=new THREE.CanvasTexture(c); return new THREE.Sprite(new THREE.SpriteMaterial({map:t,transparent:true}))
  }
  function makePad(text, col){
    const g=new THREE.Group();
    const base=new THREE.Mesh(new THREE.CylinderGeometry(6,6,0.4,32), new THREE.MeshStandardMaterial({color:col}));
    base.position.y=.2; g.add(base);
    const ring=new THREE.Mesh(new THREE.RingGeometry(3.4,5.4,48), new THREE.MeshBasicMaterial({color:0xffffff, side:THREE.DoubleSide}));
    ring.rotation.x=-Math.PI/2; ring.position.y=.41; g.add(ring);
    const s=labelSprite(text,'#76e1ff'); s.scale.set(10,5,1); s.position.set(0,3,0); g.add(s);
    return g;
  }
  const padA=makePad('A',0x10b981); padA.position.set(0,0,0); scene.add(padA);
  const padB=makePad('B',0xf59e0b); padB.position.set(120,0,-160); scene.add(padB);

  // Hélico stylisé
  const heli=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(3.2,1.6,6), new THREE.MeshStandardMaterial({color:0x6b7280, roughness:.85})); body.position.y=1.4; heli.add(body);
  const patins=new THREE.Mesh(new THREE.TorusGeometry(2.6,.08,8,32), new THREE.MeshStandardMaterial({color:0x9ca3af})); patins.rotation.x=Math.PI/2; patins.position.y=.5; heli.add(patins);
  const m=new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,1.1,10), new THREE.MeshStandardMaterial({color:0xd1d5db})); m.position.set(0,2.1,0); heli.add(m);
  const rotor=new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,10.5,22), new THREE.MeshStandardMaterial({color:0xe5e7eb})); rotor.rotation.z=Math.PI/2; rotor.position.set(0,2.6,0); heli.add(rotor);
  const tail=new THREE.Mesh(new THREE.BoxGeometry(.5,.5,5), new THREE.MeshStandardMaterial({color:0x6b7280})); tail.position.set(0,1.6,-5.5); heli.add(tail);
  const anti=new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,1.8,12), new THREE.MeshStandardMaterial({color:0xffffff})); anti.rotation.x=Math.PI/2; anti.position.set(.6,1.6,-8); heli.add(anti);
  scene.add(heli);

  // Poses initiales
  heli.position.set(0,.6,0);
  const camFPVOffset = new THREE.Vector3(0,1.9,1.5);
  const chaseOffset = new THREE.Vector3(-10,6,14);

  // Physique (simplifiée)
  const S={mass:900, g:9.81, throttle:0, maxLift:1.9, vel:new THREE.Vector3(), pitch:0, roll:0, yaw:0, paused:false};

  // Entrées clavier
  const keys=new Set();
  addEventListener('keydown',e=>{keys.add(e.key.toLowerCase()); if(e.key===' ') e.preventDefault()});
  addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

  // Audio (bruit rotor) via WebAudio
  let actx, osc, gain;
  function primeAudio(){ if(actx) return; actx=new (window.AudioContext||window.webkitAudioContext)(); osc=actx.createOscillator(); osc.type='sawtooth'; gain=actx.createGain(); gain.gain.value=0.0001; const lpf=actx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=600; osc.connect(lpf).connect(gain).connect(actx.destination); osc.start(); }
  document.body.addEventListener('pointerdown', primeAudio, {once:true});

  // Redimensionnement
  function resize(){
    const r1=canvasFPV.getBoundingClientRect(); renFPV.setSize(r1.width,r1.height,false); camFPV.aspect=r1.width/r1.height; camFPV.updateProjectionMatrix();
    const r2=canvasEXT.getBoundingClientRect(); renEXT.setSize(r2.width,r2.height,false); camEXT.aspect=r2.width/r2.height; camEXT.updateProjectionMatrix();
  }
  new ResizeObserver(resize).observe(document.body); resize();

  // HUD
  const horizon=document.getElementById('horizon'), compass=document.getElementById('compass');
  const hctx=horizon.getContext('2d'), cctx=compass.getContext('2d');
  function drawHorizon(pitch,roll){
    const w=horizon.width,h=horizon.height; hctx.clearRect(0,0,w,h); hctx.save(); hctx.translate(w/2,h/2); hctx.rotate(-roll); const pxPerDeg=2; const y=THREE.MathUtils.radToDeg(pitch)*pxPerDeg; hctx.fillStyle='#0b2a44'; hctx.fillRect(-w,-h*2+y,w*2,h*2); hctx.fillStyle='#2b1e13'; hctx.fillRect(-w,0+y,w*2,h*2); hctx.strokeStyle='#76e1ff'; hctx.lineWidth=2; hctx.beginPath(); hctx.moveTo(-w,y); hctx.lineTo(w,y); hctx.stroke(); hctx.restore(); document.getElementById('rollTxt').textContent=`Roulis ${(THREE.MathUtils.radToDeg(roll)|0)}°`; document.getElementById('pitchTxt').textContent=`Tangage ${(THREE.MathUtils.radToDeg(pitch)|0)}°`; }
  function drawCompass(yaw){ const w=compass.width,h=compass.height; cctx.clearRect(0,0,w,h); const hdg=(THREE.MathUtils.radToDeg(yaw)%360+360)%360; cctx.fillStyle='#0b1220'; cctx.fillRect(0,0,w,h); cctx.strokeStyle='#76e1ff'; cctx.lineWidth=2; cctx.beginPath(); cctx.moveTo(0,h/2); cctx.lineTo(w,h/2); cctx.stroke(); cctx.fillStyle='#c7d2fe'; cctx.textAlign='center'; cctx.font='bold 20px system-ui'; cctx.fillText(`${hdg|0}°`, w/2, h/2-10); cctx.strokeStyle='#334155'; for(let i=-6;i<=6;i++){ const x=w/2+i*22; cctx.beginPath(); cctx.moveTo(x,h/2+6); cctx.lineTo(x,h/2+(i%3?12:18)); cctx.stroke(); if(i%3==0){ cctx.fillStyle='#94a3b8'; cctx.font='12px system-ui'; const v=((hdg+i*30)%360+360)%360; cctx.fillText(v.toString().padStart(3,'0'),x,h/2+36); } } document.getElementById('hdg').textContent=hdg|0; }

  // Utilitaires
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  // Boucle
  let last=performance.now(), arrived=false; const hdr=document.getElementById('hdr');
  function reset(){ heli.position.set(0,.6,0); S.vel.set(0,0,0); S.pitch=S.roll=S.yaw=0; S.throttle=0; arrived=false; document.getElementById('state').textContent='Au sol'; }
  reset();

  function step(now){
    const dt=Math.min((now-last)/1000, .04); last=now;
    if(!S.paused){
      // Entrées
      if(keys.has(' ')) S.throttle+=.35*dt; if(keys.has('shift')) S.throttle-=.35*dt; if(keys.has('arrowup')) S.pitch-=.7*dt; if(keys.has('arrowdown')) S.pitch+=.7*dt; if(keys.has('arrowleft')) S.roll+=.7*dt; if(keys.has('arrowright')) S.roll-=.7*dt; if(keys.has('a')) S.yaw+=.9*dt; if(keys.has('d')) S.yaw-=.9*dt; if(keys.has('r')) reset(); if(keys.has('p')) S.paused=true; S.throttle=clamp(S.throttle,0,1);
      if(gain){ gain.gain.value=.02+S.throttle*.12; osc.frequency.value=140+S.throttle*160; }

      // Orientation -> quaternion
      heli.quaternion.setFromEuler(new THREE.Euler(S.pitch,S.yaw,S.roll,'YXZ'));
      const up=new THREE.Vector3(0,1,0).applyQuaternion(heli.quaternion); const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(heli.quaternion);

      // Forces
      const weight=S.mass*S.g; const lift=up.clone().multiplyScalar((weight*S.maxLift*S.throttle)/S.mass); // a = F/m
      const acc=lift.add(new THREE.Vector3(0,-S.g,0));
      const tilt=Math.abs(S.pitch)+Math.abs(S.roll); acc.add(fwd.multiplyScalar(Math.sin(tilt)*4*S.throttle));

      S.vel.addScaledVector(acc,dt); S.vel.multiplyScalar(0.995); heli.position.addScaledVector(S.vel,dt);

      // Sol
      if(heli.position.y<.6){ heli.position.y=.6; S.vel.y=Math.max(0,S.vel.y*-0.15); }

      // Cameras
      const q=heli.quaternion; camFPV.position.copy(heli.position).add(camFPVOffset.clone().applyQuaternion(q)); camFPV.quaternion.copy(q); camFPV.rotateY(Math.PI); camFPV.rotateX(-.1);
      const chase=heli.position.clone().add(chaseOffset.clone().applyQuaternion(q)); camEXT.position.lerp(chase,.1); camEXT.lookAt(heli.position);

      // Mission
      const vh=Math.hypot(S.vel.x,S.vel.z); const distB=heli.position.distanceTo(new THREE.Vector3(padB.position.x,heli.position.y,padB.position.z)); const onGround=(heli.position.y<=.65);
      if(!arrived && distB<5 && onGround && vh<1 && S.throttle<.2){ arrived=true; hdr.textContent='🟢 Atterrissage réussi sur B – Mission accomplie'; }

      // KPIs
      document.getElementById('thr').textContent=((S.throttle*100)|0)+'%';
      document.getElementById('alt').textContent=(heli.position.y-.6).toFixed(1);
      document.getElementById('spd').textContent=Math.hypot(S.vel.x,S.vel.y,S.vel.z).toFixed(1);
      document.getElementById('pos').textContent=`${heli.position.x.toFixed(0)}, ${heli.position.z.toFixed(0)}`;
      document.getElementById('state').textContent=onGround?(arrived?'Arrivé B':'Au sol'):'En vol';

      // HUD & rotors
      drawHorizon(S.pitch,S.roll); drawCompass(S.yaw); rotor.rotation.y+=45*dt; anti.rotation.z+=140*dt;
    } else if(keys.has('p')) { S.paused=false; keys.delete('p'); }

    renFPV.render(scene,camFPV); renEXT.render(scene,camEXT);
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
  </script>
</body>
</html>
